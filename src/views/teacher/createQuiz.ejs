<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Tạo bài kiểm tra mới</h5>
      </div>
      <div class="card-body">
        <form id="createQuizForm" action="/teacher/quiz/create" method="POST">
          <div class="mb-3">
            <label for="title" class="form-label">Tiêu đề bài kiểm tra</label>
            <input type="text" class="form-control" id="title" name="title" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Mô tả</label>
            <textarea class="form-control" id="description" name="description" rows="2"></textarea>
          </div>

          <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Câu hỏi</h6>
              <div>
                <div class="dropdown d-inline-block">
                  <button class="btn btn-success btn-sm dropdown-toggle" type="button" id="addQuestionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-plus-circle"></i> Thêm câu hỏi
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="addQuestionDropdown">
                    <li><a class="dropdown-item" href="#" id="addMultipleChoiceBtn">Trắc nghiệm</a></li>
                    <li><a class="dropdown-item" href="#" id="addShortAnswerBtn">Trả lời ngắn</a></li>
                    <li><a class="dropdown-item" href="#" id="addMatchingBtn">Nối đáp án</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div id="questionsContainer">
                <!-- Questions will be added here dynamically -->
              </div>
              <div class="text-center mt-3" id="noQuestionsMessage">
                <p class="text-muted">Chưa có câu hỏi nào. Nhấn nút "Thêm câu hỏi" để bắt đầu.</p>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between">
            <a href="/teacher/dashboard" class="btn btn-secondary">Hủy</a>
            <button type="submit" class="btn btn-primary" id="saveQuizBtn">Lưu bài kiểm tra</button>
          </div>

          <!-- Hidden field to store the questions data -->
          <input type="hidden" name="questions" id="questionsData">
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Multiple Choice Question Template (hidden) -->
<template id="multipleChoiceTemplate">
  <div class="question-item card mb-3" data-index="{INDEX}" data-type="multiple_choice">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h6 class="mb-0">Câu hỏi <span class="question-number">{NUMBER}</span> (Trắc nghiệm)</h6>
      <button type="button" class="btn btn-danger btn-sm remove-question">
        <i class="bi bi-trash"></i> Xóa
      </button>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Nội dung câu hỏi</label>
        <textarea class="form-control question-text" rows="2" required></textarea>
      </div>
      
      <!-- Phần upload ảnh -->
      <div class="mb-3">
        <label class="form-label">Ảnh minh họa (tùy chọn)</label>
        <div class="input-group">
          <input type="file" class="form-control image-upload" accept="image/*">
          <button type="button" class="btn btn-outline-primary upload-btn">Tải lên</button>
        </div>
        <div class="image-preview mt-2" style="display: none;">
          <img src="" class="img-fluid img-thumbnail" style="max-height: 200px;">
          <button type="button" class="btn btn-sm btn-outline-danger remove-image">Xóa ảnh</button>
          <input type="hidden" class="question-image-path">
        </div>
      </div>
      
      <div class="mb-3">
        <label class="form-label">Các đáp án</label>
        <div class="options-container">
          <div class="option-item input-group mb-2">
            <div class="input-group-text">
              <input type="radio" name="correct-{INDEX}" class="option-correct" checked>
            </div>
            <input type="text" class="form-control option-text" placeholder="Nhập đáp án" required>
            <button type="button" class="btn btn-outline-danger remove-option">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm add-option mt-2">
          <i class="bi bi-plus"></i> Thêm đáp án
        </button>
      </div>
    </div>
  </div>
</template>

<!-- Short Answer Question Template (hidden) -->
<template id="shortAnswerTemplate">
  <div class="question-item card mb-3" data-index="{INDEX}" data-type="short_answer">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h6 class="mb-0">Câu hỏi <span class="question-number">{NUMBER}</span> (Trả lời ngắn)</h6>
      <button type="button" class="btn btn-danger btn-sm remove-question">
        <i class="bi bi-trash"></i> Xóa
      </button>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Nội dung câu hỏi</label>
        <textarea class="form-control question-text" rows="2" required></textarea>
      </div>
      
      <!-- Phần upload ảnh -->
      <div class="mb-3">
        <label class="form-label">Ảnh minh họa (tùy chọn)</label>
        <div class="input-group">
          <input type="file" class="form-control image-upload" accept="image/*">
          <button type="button" class="btn btn-outline-primary upload-btn">Tải lên</button>
        </div>
        <div class="image-preview mt-2" style="display: none;">
          <img src="" class="img-fluid img-thumbnail" style="max-height: 200px;">
          <button type="button" class="btn btn-sm btn-outline-danger remove-image">Xóa ảnh</button>
          <input type="hidden" class="question-image-path">
        </div>
      </div>
      
      <div class="mb-3">
        <label class="form-label">Đáp án đúng</label>
        <input type="text" class="form-control short-answer" placeholder="Nhập đáp án đúng" required>
        <div class="form-text">Học sinh sẽ cần nhập câu trả lời khớp với đáp án này (không phân biệt hoa thường).</div>
      </div>
    </div>
  </div>
</template>

<!-- Matching Question Template (hidden) -->
<template id="matchingTemplate">
  <div class="question-item card mb-3" data-index="{INDEX}" data-type="matching">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h6 class="mb-0">Câu hỏi <span class="question-number">{NUMBER}</span> (Nối đáp án)</h6>
      <button type="button" class="btn btn-danger btn-sm remove-question">
        <i class="bi bi-trash"></i> Xóa
      </button>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Nội dung câu hỏi</label>
        <textarea class="form-control question-text" rows="2" required></textarea>
      </div>
      
      <div class="mb-3">
        <label class="form-label">Các cặp nối</label>
        <div class="matching-pairs-container">
          <div class="card mb-3 matching-pair" data-pair-index="0">
            <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
              <span>Cặp 1</span>
              <button type="button" class="btn btn-danger btn-sm remove-pair">
                <i class="bi bi-trash"></i>
              </button>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-5">
                  <label class="form-label">Bên trái</label>
                  <div class="input-group mb-3">
                    <select class="form-select left-type">
                      <option value="text">Văn bản</option>
                      <option value="image">Hình ảnh</option>
                    </select>
                  </div>
                  <div class="left-content">
                    <input type="text" class="form-control left-text" placeholder="Nội dung bên trái">
                  </div>
                  <div class="left-image-container mt-2" style="display: none;">
                    <div class="input-group">
                      <input type="file" class="form-control left-image-upload" accept="image/*">
                      <button type="button" class="btn btn-outline-primary left-upload-btn">Tải lên</button>
                    </div>
                    <div class="left-image-preview mt-2" style="display: none;">
                      <img src="" class="img-fluid img-thumbnail" style="max-height: 150px;">
                      <input type="hidden" class="left-image-path">
                    </div>
                  </div>
                </div>
                
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                  <div class="text-center">
                    <i class="bi bi-arrow-right fs-1"></i>
                  </div>
                </div>
                
                <div class="col-md-5">
                  <label class="form-label">Bên phải</label>
                  <div class="input-group mb-3">
                    <select class="form-select right-type">
                      <option value="text">Văn bản</option>
                      <option value="image">Hình ảnh</option>
                    </select>
                  </div>
                  <div class="right-content">
                    <input type="text" class="form-control right-text" placeholder="Nội dung bên phải">
                  </div>
                  <div class="right-image-container mt-2" style="display: none;">
                    <div class="input-group">
                      <input type="file" class="form-control right-image-upload" accept="image/*">
                      <button type="button" class="btn btn-outline-primary right-upload-btn">Tải lên</button>
                    </div>
                    <div class="right-image-preview mt-2" style="display: none;">
                      <img src="" class="img-fluid img-thumbnail" style="max-height: 150px;">
                      <input type="hidden" class="right-image-path">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm add-pair mt-2">
          <i class="bi bi-plus"></i> Thêm cặp nối
        </button>
      </div>
    </div>
  </div>
</template>

<%- contentFor('extraStyles') %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
  .question-item {
    border-left: 3px solid #0d6efd;
  }
  .question-item[data-type="multiple_choice"] {
    border-left-color: #0d6efd;
  }
  .question-item[data-type="short_answer"] {
    border-left-color: #198754;
  }
  .question-item[data-type="matching"] {
    border-left-color: #ffc107;
  }
  .matching-pair {
    border-left: 3px solid #6f42c1;
  }
  .draggable {
    cursor: move;
  }
</style>

<%- contentFor('extraScripts') %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const questionsContainer = document.getElementById('questionsContainer');
    const addMultipleChoiceBtn = document.getElementById('addMultipleChoiceBtn');
    const addShortAnswerBtn = document.getElementById('addShortAnswerBtn');
    const addMatchingBtn = document.getElementById('addMatchingBtn');
    const multipleChoiceTemplate = document.getElementById('multipleChoiceTemplate');
    const shortAnswerTemplate = document.getElementById('shortAnswerTemplate');
    const matchingTemplate = document.getElementById('matchingTemplate');
    const createQuizForm = document.getElementById('createQuizForm');
    const questionsData = document.getElementById('questionsData');
    const noQuestionsMessage = document.getElementById('noQuestionsMessage');
    
    let questionCount = 0;

    // Thêm các loại câu hỏi
    addMultipleChoiceBtn.addEventListener('click', function(e) {
      e.preventDefault();
      addMultipleChoiceQuestion();
    });
    
    addShortAnswerBtn.addEventListener('click', function(e) {
      e.preventDefault();
      addShortAnswerQuestion();
    });
    
    addMatchingBtn.addEventListener('click', function(e) {
      e.preventDefault();
      addMatchingQuestion();
    });

    // Xóa câu hỏi (sử dụng event delegation)
    questionsContainer.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-question') || e.target.closest('.remove-question')) {
        const questionItem = e.target.closest('.question-item');
        questionItem.remove();
        updateQuestionNumbers();
        updateNoQuestionsMessage();
      }
    });

    // Thêm đáp án mới cho câu hỏi trắc nghiệm
    questionsContainer.addEventListener('click', function(e) {
      if (e.target.classList.contains('add-option') || e.target.closest('.add-option')) {
        const questionItem = e.target.closest('.question-item');
        const optionsContainer = questionItem.querySelector('.options-container');
        const questionIndex = questionItem.getAttribute('data-index');
        
        addOption(optionsContainer, questionIndex);
      }
    });

    // Xóa đáp án
    questionsContainer.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-option') || e.target.closest('.remove-option')) {
        const optionItem = e.target.closest('.option-item');
        const optionsContainer = optionItem.closest('.options-container');
        
        // Không xóa nếu đây là đáp án cuối cùng
        if (optionsContainer.children.length > 1) {
          optionItem.remove();
        } else {
          alert('Mỗi câu hỏi phải có ít nhất một đáp án');
        }
      }
    });
    
    // Upload ảnh cho câu hỏi
    questionsContainer.addEventListener('click', function(e) {
      if (e.target.classList.contains('upload-btn') || e.target.closest('.upload-btn')) {
        const questionItem = e.target.closest('.question-item');
        const fileInput = questionItem.querySelector('.image-upload');
        const imagePreview = questionItem.querySelector('.image-preview');
        const previewImg = imagePreview.querySelector('img');
        const imagePath = questionItem.querySelector('.question-image-path');
        
        if (fileInput.files && fileInput.files[0]) {
          const formData = new FormData();
          formData.append('image', fileInput.files[0]);
          
          // Hiển thị loader
          previewImg.src = '/img/loading.gif';
          imagePreview.style.display = 'block';
          
          // Gửi request upload
          fetch('/teacher/upload-image', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              previewImg.src = data.imagePath;
              imagePath.value = data.imagePath;
              imagePreview.style.display = 'block';
            } else {
              alert('Lỗi khi tải ảnh lên: ' + data.message);
              imagePreview.style.display = 'none';
            }
          })
          .catch(error => {
            console.error('Upload error:', error);
            alert('Đã xảy ra lỗi khi tải ảnh lên.');
            imagePreview.style.display = 'none';
          });
        }
      }
    });
    
    // Xóa ảnh đã upload
    questionsContainer.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-image') || e.target.closest('.remove-image')) {
        const questionItem = e.target.closest('.question-item');
        const imagePreview = questionItem.querySelector('.image-preview');
        const imagePath = questionItem.querySelector('.question-image-path');
        const fileInput = questionItem.querySelector('.image-upload');
        
        imagePreview.style.display = 'none';
        imagePath.value = '';
        fileInput.value = '';
      }
    });
    
    // Xử lý các cặp nối trong câu hỏi matching
    questionsContainer.addEventListener('click', function(e) {
      // Thêm cặp nối mới
      if (e.target.classList.contains('add-pair') || e.target.closest('.add-pair')) {
        const questionItem = e.target.closest('.question-item');
        const pairsContainer = questionItem.querySelector('.matching-pairs-container');
        const pairsCount = pairsContainer.querySelectorAll('.matching-pair').length;
        
        addMatchingPair(pairsContainer, pairsCount);
      }
      
      // Xóa cặp nối
      if (e.target.classList.contains('remove-pair') || e.target.closest('.remove-pair')) {
        const pairItem = e.target.closest('.matching-pair');
        const pairsContainer = pairItem.closest('.matching-pairs-container');
        
        // Không xóa nếu đây là cặp cuối cùng
        if (pairsContainer.children.length > 1) {
          pairItem.remove();
          // Cập nhật lại số thứ tự các cặp
          pairsContainer.querySelectorAll('.matching-pair').forEach((pair, index) => {
            pair.setAttribute('data-pair-index', index);
            pair.querySelector('.card-header span').textContent = `Cặp ${index + 1}`;
          });
        } else {
          alert('Cần ít nhất một cặp nối');
        }
      }
      
      // Upload ảnh cho bên trái
      if (e.target.classList.contains('left-upload-btn') || e.target.closest('.left-upload-btn')) {
        const pairItem = e.target.closest('.matching-pair');
        const fileInput = pairItem.querySelector('.left-image-upload');
        const imagePreview = pairItem.querySelector('.left-image-preview');
        const previewImg = imagePreview.querySelector('img');
        const imagePath = pairItem.querySelector('.left-image-path');
        
        uploadMatchingImage(fileInput, previewImg, imagePath, imagePreview);
      }
      
      // Upload ảnh cho bên phải
      if (e.target.classList.contains('right-upload-btn') || e.target.closest('.right-upload-btn')) {
        const pairItem = e.target.closest('.matching-pair');
        const fileInput = pairItem.querySelector('.right-image-upload');
        const imagePreview = pairItem.querySelector('.right-image-preview');
        const previewImg = imagePreview.querySelector('img');
        const imagePath = pairItem.querySelector('.right-image-path');
        
        uploadMatchingImage(fileInput, previewImg, imagePath, imagePreview);
      }
    });
    
    // Thay đổi loại nội dung (text/image) cho cặp nối
    questionsContainer.addEventListener('change', function(e) {
      if (e.target.classList.contains('left-type')) {
        const pairItem = e.target.closest('.matching-pair');
        const leftContent = pairItem.querySelector('.left-content');
        const leftImageContainer = pairItem.querySelector('.left-image-container');
        
        if (e.target.value === 'text') {
          leftContent.style.display = 'block';
          leftImageContainer.style.display = 'none';
        } else {
          leftContent.style.display = 'none';
          leftImageContainer.style.display = 'block';
        }
      }
      
      if (e.target.classList.contains('right-type')) {
        const pairItem = e.target.closest('.matching-pair');
        const rightContent = pairItem.querySelector('.right-content');
        const rightImageContainer = pairItem.querySelector('.right-image-container');
        
        if (e.target.value === 'text') {
          rightContent.style.display = 'block';
          rightImageContainer.style.display = 'none';
        } else {
          rightContent.style.display = 'none';
          rightImageContainer.style.display = 'block';
        }
      }
    });

    // Submit form
    createQuizForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Validate
      if (questionCount === 0) {
        alert('Vui lòng thêm ít nhất một câu hỏi.');
        return;
      }
      
      // Thu thập thông tin câu hỏi
      const questions = [];
      
      document.querySelectorAll('.question-item').forEach(questionItem => {
        const questionType = questionItem.getAttribute('data-type');
        const questionText = questionItem.querySelector('.question-text').value.trim();
        
        if (!questionText) {
          alert('Vui lòng nhập nội dung cho tất cả các câu hỏi.');
          e.preventDefault();
          return;
        }
        
        // Lấy đường dẫn ảnh nếu có
        const imagePathInput = questionItem.querySelector('.question-image-path');
        const imagePath = imagePathInput ? imagePathInput.value : null;
        
        const questionData = {
          type: questionType,
          text: questionText,
          image: imagePath || null
        };
        
        // Xử lý theo từng loại câu hỏi
        if (questionType === 'multiple_choice') {
          const options = [];
          let correctOptionIndex = -1;
          
          questionItem.querySelectorAll('.option-item').forEach((optionItem, index) => {
            const optionText = optionItem.querySelector('.option-text').value.trim();
            const isCorrect = optionItem.querySelector('.option-correct').checked;
            
            if (!optionText) {
              alert('Vui lòng nhập nội dung cho tất cả các đáp án.');
              e.preventDefault();
              return;
            }
            
            options.push(optionText);
            
            if (isCorrect) {
              correctOptionIndex = index;
            }
          });
          
          if (correctOptionIndex === -1) {
            alert('Mỗi câu hỏi phải có ít nhất một đáp án đúng.');
            e.preventDefault();
            return;
          }
          
          questionData.options = options;
          questionData.correctOptionIndex = correctOptionIndex;
        }
        else if (questionType === 'short_answer') {
          const shortAnswer = questionItem.querySelector('.short-answer').value.trim();
          
          if (!shortAnswer) {
            alert('Vui lòng nhập đáp án cho câu hỏi trả lời ngắn.');
            e.preventDefault();
            return;
          }
          
          questionData.shortAnswer = shortAnswer;
        }
        else if (questionType === 'matching') {
          const matchingPairs = [];
          
          questionItem.querySelectorAll('.matching-pair').forEach(pair => {
            const leftType = pair.querySelector('.left-type').value;
            const rightType = pair.querySelector('.right-type').value;
            
            let leftContent, rightContent;
            
            if (leftType === 'text') {
              leftContent = pair.querySelector('.left-text').value.trim();
              if (!leftContent) {
                alert('Vui lòng nhập nội dung cho tất cả các cặp nối.');
                e.preventDefault();
                return;
              }
            } else {
              leftContent = pair.querySelector('.left-image-path').value;
              if (!leftContent) {
                alert('Vui lòng tải lên ảnh cho tất cả các cặp nối.');
                e.preventDefault();
                return;
              }
            }
            
            if (rightType === 'text') {
              rightContent = pair.querySelector('.right-text').value.trim();
              if (!rightContent) {
                alert('Vui lòng nhập nội dung cho tất cả các cặp nối.');
                e.preventDefault();
                return;
              }
            } else {
              rightContent = pair.querySelector('.right-image-path').value;
              if (!rightContent) {
                alert('Vui lòng tải lên ảnh cho tất cả các cặp nối.');
                e.preventDefault();
                return;
              }
            }
            
            matchingPairs.push({
              left: leftContent,
              right: rightContent,
              leftType: leftType,
              rightType: rightType
            });
          });
          
          if (matchingPairs.length < 2) {
            alert('Câu hỏi nối cần ít nhất 2 cặp.');
            e.preventDefault();
            return;
          }
          
          questionData.matchingPairs = matchingPairs;
        }
        
        questions.push(questionData);
      });
      
      // Lưu thông tin câu hỏi vào form dưới dạng JSON
      questionsData.value = JSON.stringify(questions);
      
      // Submit form
      createQuizForm.submit();
    });

    // Hàm tiện ích
    function addMultipleChoiceQuestion() {
      questionCount++;
      const questionIndex = Date.now(); // Sử dụng timestamp làm index
      
      let html = multipleChoiceTemplate.innerHTML
        .replace(/{INDEX}/g, questionIndex)
        .replace(/{NUMBER}/g, questionCount);
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      const newQuestion = tempDiv.firstElementChild;
      
      questionsContainer.appendChild(newQuestion);
      updateNoQuestionsMessage();
      
      // Thêm ít nhất 2 đáp án
      const optionsContainer = newQuestion.querySelector('.options-container');
      optionsContainer.innerHTML = ''; // Xóa đáp án mẫu
      addOption(optionsContainer, questionIndex);
      addOption(optionsContainer, questionIndex);
    }
    
    function addShortAnswerQuestion() {
      questionCount++;
      const questionIndex = Date.now();
      
      let html = shortAnswerTemplate.innerHTML
        .replace(/{INDEX}/g, questionIndex)
        .replace(/{NUMBER}/g, questionCount);
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      const newQuestion = tempDiv.firstElementChild;
      
      questionsContainer.appendChild(newQuestion);
      updateNoQuestionsMessage();
    }
    
    function addMatchingQuestion() {
      questionCount++;
      const questionIndex = Date.now();
      
      let html = matchingTemplate.innerHTML
        .replace(/{INDEX}/g, questionIndex)
        .replace(/{NUMBER}/g, questionCount);
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      const newQuestion = tempDiv.firstElementChild;
      
      questionsContainer.appendChild(newQuestion);
      updateNoQuestionsMessage();
      
      // Thêm một cặp nối ban đầu
      const pairsContainer = newQuestion.querySelector('.matching-pairs-container');
      pairsContainer.innerHTML = ''; // Xóa cặp mẫu
      addMatchingPair(pairsContainer, 0);
      addMatchingPair(pairsContainer, 1);
    }
    
    function addOption(optionsContainer, questionIndex) {
      const newOption = document.createElement('div');
      newOption.className = 'option-item input-group mb-2';
      newOption.innerHTML = `
        <div class="input-group-text">
          <input type="radio" name="correct-${questionIndex}" class="option-correct">
        </div>
        <input type="text" class="form-control option-text" placeholder="Nhập đáp án" required>
        <button type="button" class="btn btn-outline-danger remove-option">
          <i class="bi bi-x"></i>
        </button>
      `;
      
      optionsContainer.appendChild(newOption);
    }
    
    function addMatchingPair(pairsContainer, pairIndex) {
      const newPair = document.createElement('div');
      newPair.className = 'card mb-3 matching-pair';
      newPair.setAttribute('data-pair-index', pairIndex);
      
      newPair.innerHTML = `
        <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
          <span>Cặp ${pairIndex + 1}</span>
          <button type="button" class="btn btn-danger btn-sm remove-pair">
            <i class="bi bi-trash"></i>
          </button>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-5">
              <label class="form-label">Bên trái</label>
              <div class="input-group mb-3">
                <select class="form-select left-type">
                  <option value="text">Văn bản</option>
                  <option value="image">Hình ảnh</option>
                </select>
              </div>
              <div class="left-content">
                <input type="text" class="form-control left-text" placeholder="Nội dung bên trái">
              </div>
              <div class="left-image-container mt-2" style="display: none;">
                <div class="input-group">
                  <input type="file" class="form-control left-image-upload" accept="image/*">
                  <button type="button" class="btn btn-outline-primary left-upload-btn">Tải lên</button>
                </div>
                <div class="left-image-preview mt-2" style="display: none;">
                  <img src="" class="img-fluid img-thumbnail" style="max-height: 150px;">
                  <input type="hidden" class="left-image-path">
                </div>
              </div>
            </div>
            
            <div class="col-md-2 d-flex align-items-center justify-content-center">
              <div class="text-center">
                <i class="bi bi-arrow-right fs-1"></i>
              </div>
            </div>
            
            <div class="col-md-5">
              <label class="form-label">Bên phải</label>
              <div class="input-group mb-3">
                <select class="form-select right-type">
                  <option value="text">Văn bản</option>
                  <option value="image">Hình ảnh</option>
                </select>
              </div>
              <div class="right-content">
                <input type="text" class="form-control right-text" placeholder="Nội dung bên phải">
              </div>
              <div class="right-image-container mt-2" style="display: none;">
                <div class="input-group">
                  <input type="file" class="form-control right-image-upload" accept="image/*">
                  <button type="button" class="btn btn-outline-primary right-upload-btn">Tải lên</button>
                </div>
                <div class="right-image-preview mt-2" style="display: none;">
                  <img src="" class="img-fluid img-thumbnail" style="max-height: 150px;">
                  <input type="hidden" class="right-image-path">
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      pairsContainer.appendChild(newPair);
    }
    
    function uploadMatchingImage(fileInput, previewImg, imagePath, imagePreview) {
      if (fileInput.files && fileInput.files[0]) {
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        
        // Hiển thị loader
        previewImg.src = '/img/loading.gif';
        imagePreview.style.display = 'block';
        
        // Gửi request upload
        fetch('/teacher/upload-image', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            previewImg.src = data.imagePath;
            imagePath.value = data.imagePath;
            imagePreview.style.display = 'block';
          } else {
            alert('Lỗi khi tải ảnh lên: ' + data.message);
            imagePreview.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Upload error:', error);
          alert('Đã xảy ra lỗi khi tải ảnh lên.');
          imagePreview.style.display = 'none';
        });
      }
    }
    
    function updateQuestionNumbers() {
      document.querySelectorAll('.question-item').forEach((item, index) => {
        item.querySelector('.question-number').textContent = index + 1;
      });
      questionCount = document.querySelectorAll('.question-item').length;
    }
    
    function updateNoQuestionsMessage() {
      if (questionsContainer.children.length === 0) {
        noQuestionsMessage.style.display = 'block';
      } else {
        noQuestionsMessage.style.display = 'none';
      }
    }
  });
</script>