<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Bảng điều khiển giáo viên</h2>
      <a href="/teacher/quiz/create" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Tạo bài kiểm tra mới
      </a>
    </div>

    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Danh sách bài kiểm tra</h5>
      </div>
      <div class="card-body">
        <% if (quizzes && quizzes.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Tiêu đề</th>
                  <th>Mô tả</th>
                  <th>Số câu hỏi</th>
                  <th>Trạng thái</th>
                  <th>Ngày tạo</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <% quizzes.forEach(quiz => { %>
                  <tr>
                    <td><%= quiz.title %></td>
                    <td><%= quiz.description %></td>
                    <td><%= quiz.questions.length %></td>
                    <td>
                      <span class="badge <%= quiz.isActive ? 'bg-success' : 'bg-secondary' %>">
                        <%= quiz.isActive ? 'Đang mở' : 'Đã đóng' %>
                      </span>
                    </td>
                    <td><%= new Date(quiz.createdAt).toLocaleDateString('vi-VN') %></td>
                    <td>
                      <div class="btn-group" role="group">
                        <a href="/teacher/quiz/edit/<%= quiz._id %>" class="btn btn-sm btn-outline-primary" title="Sửa">
                          <i class="bi bi-pencil"></i> Sửa
                        </a>
                        <button class="btn btn-sm btn-outline-success toggle-status" data-id="<%= quiz._id %>" data-status="<%= quiz.isActive %>" title="<%= quiz.isActive ? 'Đóng' : 'Mở' %> bài kiểm tra">
                          <i class="bi bi-toggle-<%= quiz.isActive ? 'on' : 'off' %>"></i> <%= quiz.isActive ? 'Đóng' : 'Mở' %>
                        </button>
                        <a href="/teacher/quiz/results/<%= quiz._id %>" class="btn btn-sm btn-outline-info" title="Xem kết quả">
                          <i class="bi bi-graph-up"></i> Kết quả
                        </a>
                        <button class="btn btn-sm btn-outline-danger delete-quiz" data-id="<%= quiz._id %>" data-title="<%= quiz.title %>" title="Xóa">
                          <i class="bi bi-trash"></i> Xóa
                        </button>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="alert alert-info">
            <p>Bạn chưa có bài kiểm tra nào. Hãy tạo bài kiểm tra mới!</p>
            <a href="/teacher/quiz/create" class="btn btn-primary">Tạo bài kiểm tra mới</a>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Delete Quiz Modal -->
<div class="modal fade" id="deleteQuizModal" tabindex="-1" aria-labelledby="deleteQuizModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteQuizModalLabel">Xác nhận xóa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn xóa bài kiểm tra "<span id="quizTitle"></span>" không?</p>
        <p class="text-danger">Hành động này không thể hoàn tác và sẽ xóa tất cả dữ liệu liên quan đến bài kiểm tra này.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <form id="deleteQuizForm" method="POST">
          <button type="submit" class="btn btn-danger">Xóa</button>
        </form>
      </div>
    </div>
  </div>
</div>

<%- contentFor('extraStyles') %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<%- contentFor('extraScripts') %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle delete quiz
    const deleteButtons = document.querySelectorAll('.delete-quiz');
    const deleteForm = document.getElementById('deleteQuizForm');
    const quizTitleElement = document.getElementById('quizTitle');
    const deleteQuizModal = new bootstrap.Modal(document.getElementById('deleteQuizModal'));
    
    deleteButtons.forEach(button => {
      button.addEventListener('click', function() {
        const quizId = this.getAttribute('data-id');
        const quizTitle = this.getAttribute('data-title');
        
        deleteForm.action = `/teacher/quiz/delete/${quizId}`;
        quizTitleElement.textContent = quizTitle;
        deleteQuizModal.show();
      });
    });

    // Handle toggle quiz status
    const toggleButtons = document.querySelectorAll('.toggle-status');
    toggleButtons.forEach(button => {
      button.addEventListener('click', async function() {
        const quizId = this.getAttribute('data-id');
        
        try {
          const response = await fetch(`/quiz/${quizId}/toggle-status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Reload page to reflect changes
            window.location.reload();
          } else {
            alert('Có lỗi xảy ra khi thay đổi trạng thái bài kiểm tra');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Có lỗi xảy ra khi thay đổi trạng thái bài kiểm tra');
        }
      });
    });
  });
</script>